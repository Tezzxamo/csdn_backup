# 概要

MySQL事务是数据库层面的原子性操作单元，核心遵循ACID原则。

仅InnoDB引擎支持事务，MyISAM不支持事务。

# 一、ACID：

- 原子性（Atomicity）：事务内操作要么全部执行成功，要么全部回滚。
- 一致性（Consistency）：事务执行前后，数据库数据完整性约束不被破坏。
- 隔离性（Isolation）：并行执行的多个事务互不干扰，相互隔离。
- 持久性（Durability）：事务提交后，修改永久生效，即便数据库故障也不会丢失。

# 二、事务操作：

- 开启事务：`start transaction;` 或者 `begin;`
- 提交事务：`commit;`
- 回滚事务：`rollback;`
- 保存点：`savepoint savepoint_name;` + `rollback to savepoint_name;`（部分回滚）

# 三、事务隔离级别：

`数据库默认隔离级别：可重复读`

| 隔离级别 | 解决问题        | 存在问题              |
|------|-------------|-------------------|
| 读未提交 | -           | 脏读、不可重复读、幻读       |
| 读已提交 | 脏读          | 不可重复读、幻读          |
| 可重复读 | 脏读、不可重复读    | 幻读（InnoDB不会出现该问题） |
| 串行化  | 脏读、不可重复读、幻读 | 性能低               |

- 脏读：
    - 定义：一个事务A读到另一个事务B尚未提交的修改数据，而事务B可能回滚数据，导致事务A读取到无效的脏数据。
    - 解决方式：隔离级别提升到至少“读已提交”，可以避免读取到未提交的数据。
- 不可重复读：
    - 定义：同一个事务内，多次读取同一行数据，结果不一致。（因为期间被其他事务提交了修改/删除操作）
    - 解决方式：隔离级别提升到至少“可重复读”，该级别，事务开启后读取的数据版本固定（快照读），即使其他事务提交了修改，本事务内多次读取结果仍一致。
- 幻读：
    - 定义：同一个事务内，多次执行相同的范围查询，结果集的行数/内容不一致。
    - 解决方式：
        - 方式一：隔离级别提升到“串行化”，强制事务串行执行，完全避免所有并发问题，但是性能极低。（表级锁）
        - 方式二：当前读情况下，使用`Next-Key Lock`（行锁+间隙锁）阻止其他事务在查询范围内插入/删除数据。
        - 方式三：快照读情况下，使用MVCC（多版本并发控制）解决幻读。事务首次查询时会生成一个快照，后续查询均基于此快照查询数据。

# MVCC：

`MVCC（多版本并发控制）（Multi-Version Concurrency Control）`

- InnoDB为每行数据保存多个历史版本，当某个事物需要读取数据时，数据库会从这些版本中选出一个对`该事务可见`
  的版本（通常是事务开始时的快照），而不是直接读取最新的数据，这样读操作就不会被正在进行的写操作阻塞，实现了非阻塞读。


